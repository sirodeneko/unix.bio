import Layout from 'lib/components/layout'
import {} from '@geist-ui/react'

export const meta = {
  title: 'æ·±å…¥ç†è§£ Golang Channel',
  date: '2021-03-29T07:19:47.180Z',
  description: 'æ·±å…¥ç†è§£`Golang Channel`',
  image: 'https://blog.xiaosiro.cn/assets/hchan.png',
}

## æ·±å…¥ç†è§£`Golang Channel`

#### ä¸€ã€å¼•è¨€

`Golang`ä½¿ç”¨`Groutine`å’Œ`channels`å®ç°äº†`CSP(Communicating Sequential Processes)`æ¨¡å‹ï¼Œ`channles`åœ¨`goroutine`çš„é€šä¿¡å’ŒåŒæ­¥ä¸­æ‰¿æ‹…ç€é‡è¦çš„è§’è‰²ã€‚

channelå¯ä»¥å¤©ç„¶çš„å®ç°äº†ä»¥ä¸‹ç‰¹æ€§ï¼š

- goroutineå®‰å…¨
- åœ¨ä¸åŒçš„goroutineä¹‹é—´å­˜å‚¨å’Œä¼ è¾“å€¼ - æä¾›FIFOè¯­ä¹‰(buffered channelæä¾›)
- å¯ä»¥è®©goroutine block/unblock

#### äºŒã€`chan`åº•å±‚ç»“æ„

**channelçš„æ•´ä½“ç»“æ„å›¾:**

![hchan](/assets/hchan.png)

```
src/runtime/chan.go

type hchan struct {
    qcount   uint           // total data in the queue
    dataqsiz uint           // size of the circular queue
    buf      unsafe.Pointer // points to an array of dataqsiz elements
    elemsize uint16
    closed   uint32
    elemtype *_type // element type
    sendx    uint   // send index
    recvx    uint   // receive index
    recvq    waitq  // list of recv waiters
    sendq    waitq  // list of send waiters

    // lock protects all fields in hchan, as well as several
    // fields in sudogs blocked on this channel.
    //
    // Do not change another G's status while holding this lock
    // (in particular, do not ready a G), as this can deadlock
    // with stack shrinking.
    lock mutex
}
```

ç®€å•è¯´æ˜ï¼š

- `buf`æ˜¯æœ‰ç¼“å†²çš„channelæ‰€ç‰¹æœ‰çš„ç»“æ„ï¼Œç”¨æ¥å­˜å‚¨ç¼“å­˜æ•°æ®ã€‚æ˜¯ä¸ªå¾ªç¯é“¾è¡¨
- `sendx`å’Œ`recvx`ç”¨äºè®°å½•`buf`è¿™ä¸ªå¾ªç¯é“¾è¡¨ä¸­çš„~~å‘é€æˆ–è€…æ¥æ”¶çš„~~index
- `lock`æ˜¯ä¸ªäº’æ–¥é”ã€‚
- `recvq`å’Œ`sendq`åˆ†åˆ«æ˜¯æ¥æ”¶(<-channel)æˆ–è€…å‘é€(channel <- xxx)çš„goroutineæŠ½è±¡å‡ºæ¥çš„ç»“æ„ä½“**`sudog`**çš„é˜Ÿåˆ—ã€‚æ˜¯ä¸ªåŒå‘é“¾è¡¨

#### ä¸‰ã€åˆ›å»º

```
ch := make(chan int, 3)
```

åˆ›å»º`channel`å®é™…ä¸Šå°±æ˜¯åœ¨**è¯¥è¿›ç¨‹çš„`heap`åŒº**ç”³è¯·ä¸€å—å†…å­˜,åˆ›å»ºäº†ä¸€ä¸ª`hchan`çš„ç»“æ„ä½“ï¼Œå¹¶è¿”å›ä¸€ä¸ª`ch`æŒ‡é’ˆï¼Œæˆ‘ä»¬ä½¿ç”¨è¿‡ç¨‹ä¸­`channe`låœ¨å‡½æ•°ä¹‹é—´çš„ä¼ é€’éƒ½æ˜¯ç”¨çš„è¿™ä¸ªæŒ‡é’ˆï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆå‡½æ•°ä¼ é€’ä¸­æ— éœ€ä½¿ç”¨`channel`çš„æŒ‡é’ˆï¼Œè€Œç›´æ¥ç”¨`channel`å°±è¡Œäº†ï¼Œå› ä¸º`channel`æœ¬èº«å°±æ˜¯ä¸€ä¸ªæŒ‡é’ˆã€‚

`hchan`ç»“æ„ä½“ä½¿**ç”¨ä¸€ä¸ªå¾ªç¯é˜Ÿåˆ—**æ¥ä¿å­˜`groutine`ä¹‹é—´ä¼ é€’çš„æ•°æ®(å¦‚æœæ˜¯ç¼“å­˜`channel`çš„è¯)ï¼Œä½¿ç”¨**ä¸¤ä¸ªlist**ä¿å­˜åƒè¯¥`chan`å‘é€å’Œä»è¯¥`chan`æ¥æ”¶æ•°æ®çš„`goroutine`ï¼Œè¿˜æœ‰ä¸€ä¸ª`mutex`æ¥ä¿è¯æ“ä½œè¿™äº›ç»“æ„çš„å®‰å…¨ã€‚

è‡³äºä¸ºä»€ä¹ˆchannelä¼šä½¿ç”¨å¾ªç¯é“¾è¡¨ä½œä¸ºç¼“å­˜ç»“æ„ï¼Œæˆ‘ä¸ªäººè®¤ä¸ºæ˜¯åœ¨ç¼“å­˜åˆ—è¡¨åœ¨åŠ¨æ€çš„`send`å’Œ`recv`è¿‡ç¨‹ä¸­ï¼Œå®šä½å½“å‰`send`æˆ–è€…`recvx`çš„ä½ç½®ã€é€‰æ‹©`send`çš„å’Œ`recvx`çš„ä½ç½®æ¯”è¾ƒæ–¹ä¾¿å§ï¼Œåªè¦é¡ºç€é“¾è¡¨é¡ºåºä¸€ç›´æ—‹è½¬æ“ä½œå°±å¥½ã€‚

ç¼“å­˜ä¸­æŒ‰é“¾è¡¨é¡ºåºå­˜æ”¾ï¼Œå–æ•°æ®çš„æ—¶å€™æŒ‰é“¾è¡¨é¡ºåºè¯»å–ï¼Œç¬¦åˆFIFOçš„åŸåˆ™ã€‚

#### å››ã€å‘é€å’Œæ¥æ”¶

å‘`channel`å‘é€å’Œä»`channel`æ¥æ”¶æ•°æ®ä¸»è¦æ¶‰åŠ`hchan`é‡Œçš„å››ä¸ªæˆå‘˜å˜é‡ï¼Œæˆ‘ä»¬é€šè¿‡ä»¥ä¸‹åŠ¨å›¾æ¥åˆ†æå‘é€å’Œæ¥æ”¶çš„è¿‡ç¨‹ã€‚

![channel_buf](/assets/channel_buf.gif)

ä¸¾ä¸ªğŸŒ°:

```
//G1
func main(){
    ...

    for _, task := range hellaTasks {
        ch <- task    //sender
    }

    ...
}

//G2
func worker(ch chan Task){
    for {
       //æ¥å—ä»»åŠ¡
       task := <- ch  //recevier
       process(task)
    }
}
```

å…¶ä¸­`G1`æ˜¯å‘é€è€…ï¼Œ`G2`æ˜¯æ¥æ”¶ï¼Œå› ä¸º`ch`æ˜¯é•¿åº¦ä¸º3çš„å¸¦ç¼“å†²`channel`ï¼Œåˆå§‹çš„æ—¶å€™`hchan`ç»“æ„ä½“çš„`buf`ä¸ºç©ºï¼Œ`sendx`å’Œ`recvx`éƒ½ä¸º0ï¼Œå½“G1å‘`ch`é‡Œå‘é€æ•°æ®çš„æ—¶å€™ï¼Œä¼šé¦–å…ˆå¯¹`buf`åŠ é”ï¼Œç„¶åå°†è¦å‘é€çš„**æ•°æ®copyåˆ°`buf`é‡Œ**ï¼Œå¹¶å¢åŠ `sendx`çš„å€¼ï¼Œæœ€åé‡Šæ”¾`buf`çš„é”ã€‚ç„¶åG2æ¶ˆè´¹çš„æ—¶å€™é¦–å…ˆå¯¹`buf`åŠ é”ï¼Œç„¶åå°†`buf`é‡Œçš„**æ•°æ®copyåˆ°taskå˜é‡å¯¹åº”çš„å†…å­˜é‡Œ**ï¼Œå¢åŠ `recvx`ï¼Œæœ€åé‡Šæ”¾é”ã€‚æ•´ä¸ªè¿‡ç¨‹ï¼ŒG1å’ŒG2æ²¡æœ‰å…±äº«çš„å†…å­˜ï¼Œåº•å±‚é€šè¿‡`hchan`ç»“æ„ä½“çš„`buf`ï¼Œä½¿ç”¨copyå†…å­˜çš„æ–¹å¼è¿›è¡Œé€šä¿¡ï¼Œæœ€åè¾¾åˆ°äº†å…±äº«å†…å­˜çš„ç›®çš„ï¼Œè¿™å®Œå…¨ç¬¦åˆCSPçš„è®¾è®¡ç†å¿µã€‚

##### Goroutine Pause/Resume

æˆ‘ä»¬çŸ¥é“ï¼ŒGoçš„goroutineæ˜¯ç”¨æˆ·æ€çš„çº¿ç¨‹(`user-space threads`)ï¼Œç”¨æˆ·æ€çš„çº¿ç¨‹æ˜¯éœ€è¦è‡ªå·±å»è°ƒåº¦çš„ï¼ŒGoæœ‰è¿è¡Œæ—¶çš„è°ƒåº¦å™¨å»å¸®æˆ‘ä»¬å®Œæˆè°ƒåº¦è¿™ä»¶äº‹æƒ…ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒG2çš„æ¶ˆè´¹é€Ÿåº¦åº”è¯¥æ˜¯æ…¢äºG1çš„ï¼Œæ‰€ä»¥`buf`çš„æ•°æ®ä¼šè¶Šæ¥è¶Šå¤šï¼Œè¿™ä¸ªæ—¶å€™G1å†å‘`ch`é‡Œå‘é€æ•°æ®ï¼Œè¿™ä¸ªæ—¶å€™G1å°±ä¼šé˜»å¡ï¼Œé‚£ä¹ˆé˜»å¡åˆ°åº•æ˜¯å‘ç”Ÿäº†ä»€ä¹ˆå‘¢ï¼Ÿ

å½“G1å‘`buf`å·²ç»æ»¡äº†çš„`ch`å‘é€æ•°æ®çš„æ—¶å€™ï¼Œå½“`runtine`æ£€æµ‹åˆ°å¯¹åº”çš„`hchan`çš„`buf`å·²ç»æ»¡äº†ï¼Œä¼šé€šçŸ¥è°ƒåº¦å™¨ï¼Œè°ƒåº¦å™¨ä¼šå°†G1çš„çŠ¶æ€è®¾ç½®ä¸º`waiting`, ç§»é™¤ä¸çº¿ç¨‹Mçš„è”ç³»ï¼Œç„¶åä»Pçš„`runqueue`ä¸­é€‰æ‹©ä¸€ä¸ª`goroutine`åœ¨çº¿ç¨‹Mä¸­æ‰§è¡Œï¼Œæ­¤æ—¶G1å°±æ˜¯é˜»å¡çŠ¶æ€ï¼Œä½†æ˜¯ä¸æ˜¯æ“ä½œç³»ç»Ÿçš„çº¿ç¨‹é˜»å¡ï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™åªç”¨æ¶ˆè€—å°‘é‡çš„èµ„æºã€‚

é‚£ä¹ˆG1è®¾ç½®ä¸º`waiting`çŠ¶æ€åå»å“ªäº†ï¼Ÿæ€ä»¬å»`resume`å‘¢ï¼Ÿæˆ‘ä»¬å†å›åˆ°`hchan`ç»“æ„ä½“ï¼Œæ³¨æ„åˆ°`hchan`æœ‰ä¸ª`sendq`çš„æˆå‘˜ï¼Œå…¶ç±»å‹æ˜¯`waitq`ï¼ŒæŸ¥çœ‹æºç å¦‚ä¸‹ï¼š

```
type waitq struct { 
    first *sudog 
    last *sudog 
} 
```

å®é™…ä¸Šï¼Œå½“G1å˜ä¸ºwaitingçŠ¶æ€åï¼Œä¼šåˆ›å»ºä¸€ä¸ªä»£è¡¨è‡ªå·±çš„`sudog`çš„ç»“æ„ï¼Œç„¶åæ”¾åˆ°`sendq`è¿™ä¸ªlistä¸­ï¼Œ`sudog`ç»“æ„ä¸­ä¿å­˜äº†`channel`ç›¸å…³çš„å˜é‡çš„æŒ‡é’ˆ(å¦‚æœè¯¥Goroutineæ˜¯senderï¼Œé‚£ä¹ˆä¿å­˜çš„æ˜¯å¾…å‘é€æ•°æ®çš„å˜é‡çš„åœ°å€ï¼Œå¦‚æœæ˜¯receiveråˆ™ä¸ºæ¥æ”¶æ•°æ®çš„å˜é‡çš„åœ°å€ï¼Œä¹‹æ‰€ä»¥æ˜¯åœ°å€ï¼Œå‰é¢æˆ‘ä»¬æåˆ°åœ¨ä¼ è¾“æ•°æ®çš„æ—¶å€™ä½¿ç”¨çš„æ˜¯copyçš„æ–¹å¼)

![sudog](/assets/sudog.png)

å½“`G2`ä»ä¸­æ¥æ”¶ä¸€ä¸ªæ•°æ®æ—¶ï¼Œä¼šé€šçŸ¥è°ƒåº¦å™¨ï¼Œè®¾ç½®G1çš„çŠ¶æ€ä¸º`runnable`ï¼Œç„¶åå°†åŠ å…¥Pçš„`runqueue`é‡Œï¼Œç­‰å¾…è¢«è°ƒåº¦æ‰§è¡Œ.

##### wait empty channel

å‰é¢æˆ‘ä»¬æ˜¯å‡è®¾G1å…ˆè¿è¡Œï¼Œå¦‚æœG2å…ˆè¿è¡Œä¼šæ€ä¹ˆæ ·å‘¢ï¼Ÿå¦‚æœG2å…ˆè¿è¡Œï¼Œé‚£ä¹ˆG2ä¼šä»ä¸€ä¸ªemptyçš„`channel`é‡Œå–æ•°æ®ï¼Œè¿™ä¸ªæ—¶å€™G2å°±ä¼šé˜»å¡ï¼Œå’Œå‰é¢ä»‹ç»çš„G1é˜»å¡ä¸€æ ·ï¼ŒG2ä¹Ÿä¼šåˆ›å»ºä¸€ä¸ª`sudog`ç»“æ„ä½“ï¼Œä¿å­˜æ¥æ”¶æ•°æ®çš„å˜é‡çš„åœ°å€ï¼Œä½†æ˜¯è¯¥`sudog`ç»“æ„ä½“æ˜¯æ”¾åˆ°äº†`recvq`åˆ—è¡¨é‡Œï¼Œå½“G1å‘`ch`å‘é€æ•°æ®çš„æ—¶å€™ï¼Œ**`runtime`å¹¶æ²¡æœ‰å¯¹`hchan`ç»“æ„ä½“é¢˜çš„`buf`è¿›è¡ŒåŠ é”ï¼Œè€Œæ˜¯ç›´æ¥å°†G1é‡Œçš„å‘é€åˆ°`ch`çš„æ•°æ®copyåˆ°äº†G2 `sudog`é‡Œå¯¹åº”çš„`elem`æŒ‡å‘çš„å†…å­˜åœ°å€ï¼**è¿™ç§æ–¹å¼éå¸¸çš„èµï¼åœ¨å”¤é†’è¿‡ç¨‹ä¸­ï¼ŒG2æ— éœ€å†è·å¾—channelçš„é”ï¼Œç„¶åä»ç¼“å­˜ä¸­å–æ•°æ®ã€‚å‡å°‘äº†å†…å­˜çš„copyï¼Œæé«˜äº†æ•ˆç‡ã€‚

![wait-empty-channel](/assets/wait-empty-channel.png)

#### äº”ã€æ€»ç»“

`Golang`çš„ä¸€å¤§ç‰¹è‰²å°±æ˜¯å…¶ç®€å•é«˜æ•ˆçš„å¤©ç„¶å¹¶å‘æœºåˆ¶ï¼Œä½¿ç”¨`goroutine`å’Œ`channel`å®ç°äº†`CSP`æ¨¡å‹ã€‚ç†è§£`channel`çš„åº•å±‚è¿è¡Œæœºåˆ¶å¯¹çµæ´»è¿ç”¨`golang`å¼€å‘å¹¶å‘ç¨‹åºæœ‰å¾ˆå¤§çš„å¸®åŠ©ï¼Œç„¶åç»“åˆ`golang` `runtime`ç›¸å…³çš„æºç ,å¯¹`channel`çš„è®¤è¯†æ›´åŠ çš„æ·±åˆ»ã€‚



export default ({ children }) => <Layout meta={meta}>{children}</Layout>
